# Безошибочная сборка заказов

## Описание

Функционал безошибочной сборки обеспечивает двухэтапную проверку заказов:

1. **Сканирование товаров** - проверка каждого товара через МойСклад API
2. **Сканирование этикетки** - финальная проверка после сборки всех товаров

## Этапы работы

### Этап 1: Сканирование товаров

1. Сотрудник открывает заказ для обработки
2. Сканирует штрихкод каждого товара
3. Система отправляет запрос к МойСклад API для проверки:
   - Получает список баркодов товара по артикулу из МойСклад
   - Сравнивает отсканированный баркод с баркодами из МойСклад
   - Если баркод совпадает - товар помечается как отсканированный
   - Если не совпадает - показывается ошибка

4. После сканирования всех товаров появляется уведомление о завершении сборки

### Этап 2: Сканирование этикетки заказа

1. После успешного сканирования всех товаров появляется поле для сканирования этикетки
2. Сотрудник сканирует этикетку заказа (обычно совпадает с номером заказа)
3. Система проверяет соответствие этикетки номеру заказа
4. После успешного сканирования:
   - Заказ помечается как полностью обработанный
   - Модальное окно автоматически закрывается
   - Следующий заказ становится доступным для обработки

## Интеграция с МойСклад API

### Конфигурация

Токен доступа к МойСклад API настраивается в файле `src/services/moySkladService.js`:

```javascript
const MS_TOKEN = '38946db586067d35f5458aef5975969c16c01526';
const MS_BASE_URL = 'https://api.moysklad.ru/api/remap/1.2';
```

### API методы

#### `getBarcodesByArticle(article)`

Получает список баркодов товара из МойСклад по артикулу.

**Запрос:**
```
GET https://api.moysklad.ru/api/remap/1.2/entity/product?filter=article={article}
```

**Заголовки:**
```
Authorization: Bearer {MS_TOKEN}
Accept: application/json;charset=utf-8
```

**Ответ:**
```json
{
  "rows": [
    {
      "barcodes": [
        "2043855094983",
        "2043017893973"
      ]
    }
  ]
}
```

#### `verifyBarcodeForArticle(scannedBarcode, article)`

Проверяет соответствие отсканированного баркода баркодам товара в МойСклад.

**Возвращает:**
```javascript
{
  valid: true/false,
  error: null или "Описание ошибки",
  barcodes: ["список баркодов из МойСклад"]
}
```

#### `verifyLabelBarcode(scannedBarcode, expectedBarcode)`

Проверяет соответствие отсканированной этикетки ожидаемому баркоду.

**Возвращает:**
```javascript
{
  valid: true/false,
  error: null или "Описание ошибки"
}
```

## Обработка ошибок

### Ошибки сканирования товаров

1. **"Штрихкод не найден в заказе"**
   - Отсканированный баркод не соответствует ни одному товару в заказе
   - Проверьте правильность сканирования

2. **"Товар уже отсканирован полностью"**
   - Превышено количество сканирований для данного товара
   - Проверьте количество в заказе

3. **"Баркод не прошёл проверку МойСклад"**
   - Баркод не найден в МойСклад для данного артикула
   - Возможно, баркод не добавлен в карточку товара в МойСклад

4. **"Ошибка проверки баркода через МойСклад"**
   - Проблема с подключением к API МойСклад
   - Проверьте интернет-соединение и токен доступа

### Ошибки сканирования этикетки

1. **"Этикетка не прошла проверку"**
   - Отсканированная этикетка не совпадает с номером заказа
   - Проверьте правильность этикетки

2. **"Сначала пройдите безошибочную сборку"**
   - Попытка сканирования этикетки до завершения сборки товаров
   - Сначала отсканируйте все товары

## Визуальная индикация

### Сканирование товаров

- **Синяя рамка** - активный товар для сканирования
- **⏳ Желтый бейдж** - товар в процессе сканирования (X / Y)
- **✓ Зеленый бейдж** - товар полностью отсканирован
- **❌ Красное сообщение** - ошибка сканирования
- **✅ Зеленое сообщение** - успешное сканирование

### Сканирование этикетки

- **Зеленое уведомление** - "Все товары отсканированы!"
- **Поле ввода** - для сканирования этикетки заказа
- **✅ Зеленое сообщение** - этикетка успешно отсканирована
- **❌ Красное сообщение** - ошибка сканирования этикетки

## Пример работы

### Заказ с двумя товарами

```javascript
{
  "postingNumber": "79373559-0053-1",
  "products": [
    {
      "name": "Лютеин и зеаксантин для глаз 60 капсул",
      "offerId": "GRA-08040",
      "barcode": "2000588832717",
      "quantity": 1
    },
    {
      "name": "Физетин, 100 мг, 60 капсул",
      "offerId": "GRA-09100",
      "barcode": "2038515111568",
      "quantity": 2
    }
  ]
}
```

### Процесс сканирования

1. **Сканируем первый товар:**
   - Сканируем баркод `2000588832717`
   - Система проверяет в МойСклад для артикула `GRA-08040`
   - Успех: "Товар отсканирован (1/1)" ✅
   - Товар помечен зеленым бейджем ✓

2. **Сканируем второй товар (дважды):**
   - Первое сканирование: `2038515111568`
   - Система проверяет в МойСклад для артикула `GRA-09100`
   - Успех: "Товар отсканирован (1/2)" ✅

   - Второе сканирование: `2038515111568`
   - Успех: "Товар отсканирован (2/2)" ✅
   - Товар помечен зеленым бейджем ✓

3. **Появляется уведомление:**
   - "✓ Все товары отсканированы!"
   - "Теперь отсканируйте этикетку заказа"

4. **Сканируем этикетку:**
   - Сканируем баркод этикетки (например, номер заказа `79373559-0053-1`)
   - Система проверяет соответствие
   - Успех: "Этикетка отсканирована успешно!" ✅

5. **Завершение:**
   - Заказ помечается как обработанный
   - Модальное окно закрывается
   - Следующий заказ становится доступным

## Настройка баркодов в МойСклад

Для корректной работы безошибочной сборки необходимо:

1. В карточке каждого товара в МойСклад должны быть указаны баркоды
2. Артикул товара (`offerId`) должен совпадать с артикулом в МойСклад
3. Баркоды могут быть в разных форматах (EAN-13, Code128, UPC и др.)

### Пример настройки в МойСклад

**Товар:** Физетин, 100 мг, 60 капсул

- **Артикул:** GRA-09100
- **Штрихкоды товара:**
  - Код: Code128
  - Значение: `2038515111568`

## Безопасность

- Токен МойСклад хранится только на клиенте
- Все запросы к МойСклад API выполняются с токеном Bearer
- При ошибках API не раскрываются детали подключения

## Производительность

- Кэширование баркодов на клиенте (в будущей версии)
- Асинхронная проверка баркодов
- Задержка 200ms перед отправкой запроса (debounce)

## Дальнейшие улучшения

1. **Серверная проверка** - перенести проверку баркодов на сервер
2. **Кэширование** - кэшировать баркоды для ускорения
3. **Статистика** - отслеживать время сборки и количество ошибок
4. **Звуковые сигналы** - для успешного/неуспешного сканирования
5. **История сканирований** - логирование всех действий сотрудника
